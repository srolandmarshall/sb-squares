name: Release
on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.3", bundler-cache: true }
      - run: bundle exec rspec --format documentation

  # Linux binary via Tebako container
  linux:
    needs: test
    runs-on: ubuntu-latest
    container: { image: ghcr.io/tamatebako/tebako-ubuntu-20.04:latest }
    steps:
      - uses: actions/checkout@v4
      - name: Allow git on mounted workspace
        run: git config --global --add safe.directory $PWD
      - name: Build Linux binary with Tebako
        run: |
          tebako press \
            --root=. \
            --entry-point=bin/squares \
            --output=sb-squares-linux-amd64 \
            --Ruby=3.3.7
      - uses: softprops/action-gh-release@v2
        with: { files: sb-squares-linux-amd64 }

  # macOS binary (Intel). Duplicate job on macos-14 for arm64 if you want both.
  macos:
    needs: test
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.3" }
      - name: Reset & update Homebrew (stabilize taps)
        run: |
          brew update-reset || true
          brew update
      - name: Install Tebako via Homebrew
        run: |
          brew tap tamatebako/tap
          brew install tebako
      - name: Build macOS binary with Tebako
        run: |
          tebako press \
            --root=. \
            --entry-point=bin/squares \
            --output=sb-squares-macos-amd64 \
            --Ruby=3.3.7
      - uses: softprops/action-gh-release@v2
        with: { files: sb-squares-macos-amd64 }

  # Windows EXE via Aibika
  windows:
    needs: test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with: { ruby-version: "3.3" }
      - run: gem install aibika
      - run: |
          bundle config set path vendor/bundle
          bundle install --without development test
      - shell: bash
        run: aibika --no-dep-run bin/squares --console --output sb-squares-windows-x64.exe
      - uses: softprops/action-gh-release@v2
        with: { files: sb-squares-windows-x64.exe }
